name: Build Linux
run-name: Build Linux ${{ github.ref_name }}

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            rust_target: x86_64-unknown-linux-gnu
            go_arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            rust_target: aarch64-unknown-linux-gnu
            go_arch: arm64
            runner: ubuntu-24.04-arm

    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout NoorNote
        uses: actions/checkout@v4

      - name: Checkout NoorSigner
        uses: actions/checkout@v4
        with:
          repository: 77elements/noorsigner
          path: noorsigner-src

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: Build NoorSigner for Linux
        run: |
          cd noorsigner-src
          GOOS=linux GOARCH=${{ matrix.go_arch }} go build -o noorsigner-${{ matrix.rust_target }} -ldflags="-s -w" .
          mkdir -p ../src-tauri/binaries
          mv noorsigner-${{ matrix.rust_target }} ../src-tauri/binaries/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libfuse2

      - name: Install npm dependencies
        run: npm ci

      # ARM64: Only deb + rpm (linuxdeploy doesn't work reliably on ARM64)
      - name: Build Tauri App (deb + rpm)
        if: matrix.arch == 'arm64'
        run: npm run tauri build -- --bundles deb,rpm

      # AMD64: All formats including AppImage
      - name: Build Tauri App (deb + rpm + appimage)
        if: matrix.arch == 'amd64'
        env:
          APPIMAGE_EXTRACT_AND_RUN: 1
        run: npm run tauri build -- --bundles deb,rpm,appimage

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            # Read version from Cargo.toml for manual triggers
            VERSION=$(grep '^version = ' src-tauri/Cargo.toml | head -1 | cut -d'"' -f2)
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Create tarball
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TARBALL_DIR="NoorNote-${VERSION}-linux-${{ matrix.arch }}"
          mkdir -p "${TARBALL_DIR}"

          # Copy NoorNote binary
          cp src-tauri/target/release/noornote "${TARBALL_DIR}/"

          # Copy NoorSigner sidecar
          cp src-tauri/binaries/noorsigner-${{ matrix.rust_target }} "${TARBALL_DIR}/"

          # Copy install script and README
          cp deployment/linux/install.sh "${TARBALL_DIR}/"
          cp deployment/linux/README.txt "${TARBALL_DIR}/"
          chmod +x "${TARBALL_DIR}/install.sh"

          # Create tarball
          tar -czvf "${TARBALL_DIR}.tar.gz" "${TARBALL_DIR}"

          echo "Created: ${TARBALL_DIR}.tar.gz"
          ls -lh "${TARBALL_DIR}.tar.gz"

      - name: Rename build outputs for consistency
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          ARCH=${{ matrix.arch }}

          # Rename .deb
          DEB_FILE=$(find src-tauri/target/release/bundle/deb -name "*.deb" | head -1)
          if [ -n "$DEB_FILE" ]; then
            mv "$DEB_FILE" "src-tauri/target/release/bundle/deb/noornote-${VERSION}-linux-${ARCH}.deb"
          fi

          # Rename .rpm (map arch names)
          RPM_FILE=$(find src-tauri/target/release/bundle/rpm -name "*.rpm" | head -1)
          if [ -n "$RPM_FILE" ]; then
            # Use x86_64 for amd64, aarch64 for arm64 in rpm naming
            if [ "$ARCH" = "amd64" ]; then
              RPM_ARCH="x86_64"
            else
              RPM_ARCH="aarch64"
            fi
            mv "$RPM_FILE" "src-tauri/target/release/bundle/rpm/noornote-${VERSION}-linux-${RPM_ARCH}.rpm"
          fi

          # Rename .AppImage (only exists for amd64)
          APPIMAGE_FILE=$(find src-tauri/target/release/bundle/appimage -name "*.AppImage" 2>/dev/null | head -1)
          if [ -n "$APPIMAGE_FILE" ]; then
            mv "$APPIMAGE_FILE" "src-tauri/target/release/bundle/appimage/noornote-${VERSION}-linux-${ARCH}.AppImage"
          fi

          # Rename tarball (already correctly named but ensure lowercase)
          TARBALL=$(ls -1 *.tar.gz 2>/dev/null | head -1)
          if [ -n "$TARBALL" ]; then
            mv "$TARBALL" "noornote-${VERSION}-linux-${ARCH}.tar.gz"
          fi

      - name: List build outputs
        run: |
          echo "=== .deb files ==="
          find src-tauri/target/release/bundle -name "*.deb" -exec ls -lh {} \; 2>/dev/null || true
          echo "=== .rpm files ==="
          find src-tauri/target/release/bundle -name "*.rpm" -exec ls -lh {} \; 2>/dev/null || true
          echo "=== .AppImage files ==="
          find src-tauri/target/release/bundle -name "*.AppImage" -exec ls -lh {} \; 2>/dev/null || true
          echo "=== .tar.gz files ==="
          ls -lh *.tar.gz 2>/dev/null || true

      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: noornote-linux-${{ matrix.arch }}-deb
          path: src-tauri/target/release/bundle/deb/*.deb

      - name: Upload .rpm
        uses: actions/upload-artifact@v4
        with:
          name: noornote-linux-${{ matrix.arch }}-rpm
          path: src-tauri/target/release/bundle/rpm/*.rpm

      - name: Upload .AppImage
        if: matrix.arch == 'amd64'
        uses: actions/upload-artifact@v4
        with:
          name: noornote-linux-${{ matrix.arch }}-appimage
          path: src-tauri/target/release/bundle/appimage/*.AppImage

      - name: Upload tarball
        uses: actions/upload-artifact@v4
        with:
          name: noornote-linux-${{ matrix.arch }}-tarball
          path: "*.tar.gz"

  release:
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download amd64 .deb
        uses: actions/download-artifact@v4
        with:
          name: noornote-linux-amd64-deb
          path: release/

      - name: Download amd64 .rpm
        uses: actions/download-artifact@v4
        with:
          name: noornote-linux-amd64-rpm
          path: release/

      - name: Download amd64 .AppImage
        uses: actions/download-artifact@v4
        with:
          name: noornote-linux-amd64-appimage
          path: release/

      - name: Download amd64 tarball
        uses: actions/download-artifact@v4
        with:
          name: noornote-linux-amd64-tarball
          path: release/

      - name: Download arm64 .deb
        uses: actions/download-artifact@v4
        with:
          name: noornote-linux-arm64-deb
          path: release/

      - name: Download arm64 .rpm
        uses: actions/download-artifact@v4
        with:
          name: noornote-linux-arm64-rpm
          path: release/

      # Note: No ARM64 AppImage - linuxdeploy doesn't work reliably on ARM64

      - name: Download arm64 tarball
        uses: actions/download-artifact@v4
        with:
          name: noornote-linux-arm64-tarball
          path: release/

      - name: List release contents
        run: ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
